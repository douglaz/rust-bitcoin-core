#!/usr/bin/env bash
set -euo pipefail

# Check if we're in a nix environment
if command -v nix >/dev/null 2>&1 && [ -f "flake.nix" ]; then
    # Use nix develop for consistent environment
    echo "Running pre-commit checks..."
    
    # Check formatting
    if ! nix develop -c cargo fmt --check 2>/dev/null; then
        echo "❌ Code is not formatted. Please run 'nix develop -c cargo fmt' before committing."
        echo ""
        echo "To automatically fix formatting:"
        echo "  nix develop -c cargo fmt"
        echo ""
        echo "To see what needs formatting:"
        echo "  nix develop -c cargo fmt --check --verbose"
        exit 1
    fi
    
    # Run clippy for basic linting (optional - just warn for now)
    # echo "Running clippy checks..."
    # if ! nix develop -c cargo clippy --all-targets -- -D warnings 2>/dev/null; then
    #     echo "⚠️  Clippy found warnings. Consider fixing them:"
    #     echo "  nix develop -c cargo clippy --all-targets"
    #     # Don't fail for now, just warn
    # fi
else
    # Fallback to regular cargo
    echo "Running pre-commit checks..."
    
    # Check formatting
    if ! cargo fmt --check 2>/dev/null; then
        echo "❌ Code is not formatted. Please run 'cargo fmt' before committing."
        echo ""
        echo "To automatically fix formatting:"
        echo "  cargo fmt"
        echo ""
        echo "To see what needs formatting:"
        echo "  cargo fmt --check --verbose"
        exit 1
    fi
    
    # Run clippy for basic linting (optional - just warn for now)
    # echo "Running clippy checks..."
    # if ! cargo clippy --all-targets -- -D warnings 2>/dev/null; then
    #     echo "⚠️  Clippy found warnings. Consider fixing them:"
    #     echo "  cargo clippy --all-targets"
    #     # Don't fail for now, just warn
    # fi
fi

echo "✅ All pre-commit checks passed"